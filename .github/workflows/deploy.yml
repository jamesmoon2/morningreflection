name: CD - Deploy to AWS

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

jobs:
  deploy-backend:
    name: Deploy Backend (CDK)
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install CDK
        run: npm install -g aws-cdk

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION || 'us-west-2' }}

      - name: CDK Bootstrap (if needed)
        run: cdk bootstrap
        continue-on-error: true

      - name: CDK Deploy
        run: cdk deploy --require-approval never --all
        env:
          CDK_DEFAULT_ACCOUNT: ${{ secrets.AWS_ACCOUNT_ID }}
          CDK_DEFAULT_REGION: ${{ secrets.AWS_REGION || 'us-west-2' }}

      - name: Get CDK Outputs
        id: cdk-outputs
        run: |
          USER_POOL_ID=$(aws cloudformation describe-stacks \
            --stack-name MorningReflectionStack \
            --query "Stacks[0].Outputs[?OutputKey=='UserPoolId'].OutputValue" \
            --output text)
          CLIENT_ID=$(aws cloudformation describe-stacks \
            --stack-name MorningReflectionStack \
            --query "Stacks[0].Outputs[?OutputKey=='UserPoolClientId'].OutputValue" \
            --output text)
          API_URL=$(aws cloudformation describe-stacks \
            --stack-name MorningReflectionStack \
            --query "Stacks[0].Outputs[?OutputKey=='ApiUrl'].OutputValue" \
            --output text)

          echo "user_pool_id=$USER_POOL_ID" >> $GITHUB_OUTPUT
          echo "client_id=$CLIENT_ID" >> $GITHUB_OUTPUT
          echo "api_url=$API_URL" >> $GITHUB_OUTPUT

    outputs:
      user_pool_id: ${{ steps.cdk-outputs.outputs.user_pool_id }}
      client_id: ${{ steps.cdk-outputs.outputs.client_id }}
      api_url: ${{ steps.cdk-outputs.outputs.api_url }}

  deploy-frontend:
    name: Deploy Frontend (Amplify)
    runs-on: ubuntu-latest
    needs: deploy-backend
    if: github.event_name == 'push' || github.event.inputs.environment == 'production'

    defaults:
      run:
        working-directory: ./frontend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Build frontend
        run: npm run build
        env:
          VITE_AWS_REGION: ${{ secrets.AWS_REGION || 'us-west-2' }}
          VITE_USER_POOL_ID: ${{ needs.deploy-backend.outputs.user_pool_id }}
          VITE_USER_POOL_CLIENT_ID: ${{ needs.deploy-backend.outputs.client_id }}
          VITE_API_URL: ${{ needs.deploy-backend.outputs.api_url }}
          VITE_APP_NAME: Morning Reflection
          VITE_APP_URL: https://app.morningreflection.com

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION || 'us-west-2' }}

      - name: Deploy to Amplify
        run: |
          # Get Amplify App ID from CDK outputs
          AMPLIFY_APP_ID=$(aws cloudformation describe-stacks \
            --stack-name MorningReflectionStack \
            --query "Stacks[0].Outputs[?OutputKey=='AmplifyAppId'].OutputValue" \
            --output text)

          if [ -n "$AMPLIFY_APP_ID" ]; then
            echo "Triggering Amplify build for app: $AMPLIFY_APP_ID"
            aws amplify start-job \
              --app-id "$AMPLIFY_APP_ID" \
              --branch-name main \
              --job-type RELEASE
          else
            echo "Amplify App ID not found. Skipping Amplify deployment."
            echo "Frontend build artifacts are in dist/ directory."
          fi

  notify-deployment:
    name: Notify Deployment
    runs-on: ubuntu-latest
    needs: [deploy-backend, deploy-frontend]
    if: always()

    steps:
      - name: Deployment Success
        if: needs.deploy-backend.result == 'success' && needs.deploy-frontend.result == 'success'
        run: |
          echo "✅ Deployment successful!"
          echo "Backend deployed via CDK"
          echo "Frontend deployed via Amplify"

      - name: Deployment Failure
        if: needs.deploy-backend.result == 'failure' || needs.deploy-frontend.result == 'failure'
        run: |
          echo "❌ Deployment failed!"
          echo "Backend: ${{ needs.deploy-backend.result }}"
          echo "Frontend: ${{ needs.deploy-frontend.result }}"
          exit 1
