# Phase 4: Frontend Development - Complete Guide

## Overview

Phase 4 implements a complete React Single Page Application (SPA) for Morning Reflection, providing users with a modern, responsive interface to view reflections, write journal entries, and manage their preferences.

**Status**: Phase 4 Complete ✅

**Technologies**:
- React 18+ with TypeScript
- Vite (build tool)
- Tailwind CSS (styling)
- AWS Amplify (Cognito authentication)
- React Router (client-side routing)
- Axios (HTTP client)
- date-fns (date utilities)

## Architecture

### Application Structure

```
frontend/
├── src/
│   ├── components/       # Reusable UI components
│   │   ├── Button.tsx
│   │   ├── Card.tsx
│   │   ├── Input.tsx
│   │   ├── Loading.tsx
│   │   ├── Layout.tsx
│   │   └── ProtectedRoute.tsx
│   ├── config/           # Configuration
│   │   └── aws-config.ts
│   ├── contexts/         # React contexts
│   │   └── AuthContext.tsx
│   ├── hooks/            # Custom React hooks
│   │   ├── useReflection.ts
│   │   └── useJournal.ts
│   ├── pages/            # Page components
│   │   ├── LoginPage.tsx
│   │   ├── SignupPage.tsx
│   │   ├── VerifyEmailPage.tsx
│   │   ├── ForgotPasswordPage.tsx
│   │   ├── DashboardPage.tsx
│   │   ├── CalendarPage.tsx
│   │   ├── DailyReflectionPage.tsx
│   │   └── SettingsPage.tsx
│   ├── services/         # API services
│   │   ├── api-client.ts
│   │   ├── user-service.ts
│   │   ├── reflection-service.ts
│   │   └── journal-service.ts
│   ├── types/            # TypeScript types
│   │   └── index.ts
│   ├── utils/            # Utility functions
│   │   ├── date-utils.ts
│   │   ├── validation.ts
│   │   └── magic-link.ts
│   ├── App.tsx           # Main app component with routing
│   ├── main.tsx          # Entry point
│   └── index.css         # Global styles (Tailwind)
├── .env                  # Environment variables (gitignored)
├── .env.example          # Environment variable template
├── amplify.yml           # Amplify build configuration
├── deploy.sh             # Deployment helper script
├── package.json
├── tsconfig.json
├── vite.config.ts
└── tailwind.config.js
```

## Features Implemented

### 1. Authentication System

**Components**: `LoginPage`, `SignupPage`, `VerifyEmailPage`, `ForgotPasswordPage`
**Context**: `AuthContext`

- Email/password authentication via AWS Cognito
- Email verification with 6-digit code
- Password reset flow
- Session management with JWT tokens
- Protected routes requiring authentication

**Key Features**:
- Password requirements: 12+ chars, uppercase, lowercase, digit, special char
- Compromised credential detection (Cognito advanced security)
- Optional 2FA (TOTP/SMS) support
- Automatic token refresh

### 2. Dashboard (Home Page)

**Component**: `DashboardPage`
**Route**: `/dashboard`

- Displays today's reflection with quote, attribution, theme, and reflection text
- Shows journaling prompt generated by Anthropic API
- Inline journal entry editor with word count
- Auto-save functionality
- Quick links to calendar and settings

### 3. Calendar View

**Component**: `CalendarPage`
**Route**: `/calendar`

- Monthly calendar grid showing all days
- Visual indicators for:
  - Days with reflections (blue dot)
  - Days with journal entries (green dot)
  - Today's date (highlighted border)
  - Word count for journal entries
- Month navigation (previous/next)
- Click any date to view that day's reflection and journal
- Recent journal entries list below calendar

### 4. Daily Reflection Page

**Component**: `DailyReflectionPage`
**Route**: `/daily/:date`

- View reflection and journal entry for any specific date
- **Magic link support**: Handles token parameter from email links
- Full reflection display with theme, quote, and journaling prompt
- Journal entry editor for that specific date
- Navigation back to calendar

**Magic Link Flow**:
1. User receives email with magic link (`/daily/2025-01-15?token=JWT`)
2. Token is parsed and validated client-side
3. If not authenticated, redirect to login with return URL
4. After login, redirect back to the intended reflection

### 5. Settings Page

**Component**: `SettingsPage`
**Route**: `/settings`

- View account information (email, user ID, join date)
- Email preferences:
  - Enable/disable daily reflection emails
  - Set delivery time (HH:MM format)
  - Select timezone
- Account deletion (GDPR-compliant)
- Sign out button

### 6. Layout & Navigation

**Component**: `Layout`

- Responsive navigation header with logo and menu
- Active route highlighting
- User email display
- Sign out functionality
- Footer with copyright
- Mobile-responsive hamburger menu (on mobile screens)

## API Integration

### Service Layer Architecture

All API calls go through a centralized service layer:

**`api-client.ts`**: Base HTTP client
- Axios instance with interceptors
- Automatic token injection in Authorization header
- Error handling and transformation
- 30-second timeout

**`user-service.ts`**: User operations
- `getUserProfile()`: Get current user profile
- `updateUserProfile()`: Update profile
- `updateUserPreferences()`: Update email preferences
- `deleteUserAccount()`: Delete account (GDPR)

**`reflection-service.ts`**: Reflection operations
- `getTodayReflection()`: Get today's reflection
- `getReflectionByDate()`: Get reflection for specific date
- `getCalendarMetadata()`: Get calendar indicators for a month

**`journal-service.ts`**: Journal operations
- `saveJournalEntry()`: Create/update journal entry
- `getJournalEntry()`: Get entry for specific date
- `deleteJournalEntry()`: Delete entry
- `getJournalList()`: Get list of all entries (metadata only)

### Authentication Flow

```
1. User signs in → Cognito returns JWT tokens
2. Tokens stored in AuthContext
3. api-client retrieves token via tokenGetter function
4. All API requests include: Authorization: Bearer <token>
5. API Gateway validates token via Cognito authorizer
6. Backend Lambda functions receive validated user claims
```

## Custom Hooks

### `useReflection(date?)`

Manages reflection loading state:
- `reflection`: Reflection object or null
- `loading`: Boolean loading state
- `error`: Error message or null
- `reload()`: Function to reload reflection

### `useJournal(date?)`

Manages journal entry state:
- `entry`: Journal entry object or null
- `loading`: Boolean loading state
- `error`: Error message or null
- `saving`: Boolean save state
- `saveEntry(text)`: Save journal entry
- `deleteEntry()`: Delete journal entry
- `reload()`: Reload entry

## Styling & Design

### Tailwind CSS Configuration

**Color Palette**:
- `primary`: Blue shades (used for buttons, links, highlights)
- `stoic`: Gray shades (used for text, backgrounds)

**Custom Components** (in `index.css`):
- `.btn-primary`: Primary action button
- `.btn-secondary`: Secondary action button
- `.input-field`: Form input field
- `.card`: Card container with shadow

**Responsive Design**:
- Mobile-first approach
- Breakpoints: `sm` (640px), `md` (768px), `lg` (1024px)
- Grid layouts adjust automatically
- Navigation collapses on mobile

### Accessibility

- Semantic HTML elements
- ARIA labels on interactive elements
- Keyboard navigation support
- Focus states on all interactive elements
- Color contrast compliance (WCAG 2.1 AA)

## Environment Configuration

### Required Environment Variables

Create `frontend/.env` with the following values (get from CDK deployment outputs):

```env
# AWS Cognito Configuration
VITE_AWS_REGION=us-west-2
VITE_USER_POOL_ID=us-west-2_XXXXXXXXX
VITE_USER_POOL_CLIENT_ID=XXXXXXXXXXXXXXXXXXXXXXXXXX

# API Gateway Configuration
VITE_API_URL=https://XXXXXXXXXX.execute-api.us-west-2.amazonaws.com/prod

# Application Configuration
VITE_APP_NAME=Morning Reflection
VITE_APP_URL=https://app.morningreflection.com
```

### Getting Environment Variable Values

After deploying backend with CDK:

```bash
# Deploy backend
cd /path/to/morningreflection
cdk deploy

# CDK will output:
# - UserPoolId
# - UserPoolClientId
# - ApiUrl
```

Copy these values into `frontend/.env`.

## Development Workflow

### Local Development

```bash
# Navigate to frontend directory
cd frontend

# Install dependencies
npm install

# Create .env file (copy from .env.example and fill in values)
cp .env.example .env

# Start development server
npm run dev

# Open browser to http://localhost:5173
```

### Build for Production

```bash
cd frontend
npm run build

# Output will be in 'dist' directory
# Contains optimized HTML, CSS, JS, and assets
```

### Type Checking

```bash
npm run tsc
```

### Linting

```bash
npm run lint
```

## Deployment Options

### Option 1: AWS Amplify Hosting (Recommended)

**Why Amplify?**
- Built-in CI/CD from Git
- Automatic SSL certificates
- Custom domain support
- Preview environments for branches
- Simple environment variable management

**Steps**:

1. **Push code to Git repository**
2. **Go to AWS Amplify Console**:
   - Navigate to: https://console.aws.amazon.com/amplify/
   - Click "New app" → "Host web app"
3. **Connect Git repository**:
   - Choose your Git provider (GitHub, GitLab, Bitbucket, etc.)
   - Authorize AWS Amplify
   - Select your repository
   - Select branch (e.g., `main` or `claude/plan-morningreflection-migration-...`)
4. **Configure build settings**:
   - App name: `morning-reflection`
   - Environment: `production`
   - Build directory: `frontend`
   - Amplify auto-detects the `amplify.yml` file
5. **Add environment variables**:
   - Go to "Environment variables" tab
   - Add all variables from your `.env` file:
     - `VITE_AWS_REGION`
     - `VITE_USER_POOL_ID`
     - `VITE_USER_POOL_CLIENT_ID`
     - `VITE_API_URL`
     - `VITE_APP_NAME`
     - `VITE_APP_URL`
6. **Deploy**:
   - Click "Save and deploy"
   - Amplify will build and deploy automatically
7. **Set up custom domain** (optional):
   - Go to "Domain management"
   - Add domain: `app.morningreflection.com`
   - Follow DNS configuration instructions

**Cost**: ~$0.50/month (assuming 1000 users, 1GB data transfer)

### Option 2: AWS S3 + CloudFront

Manual static hosting setup:

```bash
# Build frontend
cd frontend
npm run build

# Create S3 bucket
aws s3 mb s3://morningreflection-frontend

# Configure bucket for static hosting
aws s3 website s3://morningreflection-frontend \
  --index-document index.html \
  --error-document index.html

# Upload files
aws s3 sync dist/ s3://morningreflection-frontend/ \
  --acl public-read

# Create CloudFront distribution (via Console or CDK)
# Point to S3 bucket as origin
# Configure custom domain and SSL certificate
```

**Cost**: ~$0.50-1.00/month

### Option 3: Vercel / Netlify

Simple third-party hosting:

**Vercel**:
```bash
npm install -g vercel
cd frontend
vercel --prod
```

**Netlify**:
```bash
npm install -g netlify-cli
cd frontend
netlify deploy --prod --dir=dist
```

**Cost**: Free tier available, ~$0-20/month

## Testing

### Manual Testing Checklist

**Authentication**:
- [ ] Sign up with new email
- [ ] Verify email with code
- [ ] Sign in with credentials
- [ ] Sign out
- [ ] Request password reset
- [ ] Confirm password reset with code
- [ ] Invalid credentials show error

**Dashboard**:
- [ ] Today's reflection loads
- [ ] Journaling prompt appears
- [ ] Journal entry saves successfully
- [ ] Word count updates in real-time
- [ ] Quick links navigate correctly

**Calendar**:
- [ ] Calendar shows current month
- [ ] Days with reflections show blue dot
- [ ] Days with journals show green dot
- [ ] Today is highlighted
- [ ] Future dates are disabled
- [ ] Clicking date navigates to daily page
- [ ] Previous/Next month navigation works
- [ ] Recent entries list appears below

**Daily Reflection Page**:
- [ ] Reflection loads for selected date
- [ ] Journal entry loads if exists
- [ ] Journal saves successfully
- [ ] Magic link with token works
- [ ] Invalid date shows error
- [ ] Back to calendar button works

**Settings**:
- [ ] User info displays correctly
- [ ] Email toggle works
- [ ] Delivery time updates
- [ ] Timezone updates
- [ ] Settings save successfully
- [ ] Account deletion requires confirmation
- [ ] Sign out works

**Mobile Responsiveness**:
- [ ] All pages render correctly on mobile
- [ ] Navigation menu works on small screens
- [ ] Forms are usable on mobile
- [ ] Calendar is readable on mobile

## Security Considerations

### Implemented Security Measures

1. **Authentication**:
   - Cognito-managed JWT tokens
   - Secure token storage (httpOnly cookies recommended for production)
   - Automatic token expiration and refresh

2. **Input Validation**:
   - Email format validation
   - Password strength requirements (12+ chars, mixed case, numbers, symbols)
   - Time format validation (HH:MM)
   - Verification code validation (6 digits)

3. **XSS Prevention**:
   - React's built-in XSS protection
   - Input sanitization for journal entries (backend validation)
   - No dangerouslySetInnerHTML usage

4. **API Security**:
   - All API requests require valid JWT token
   - API Gateway validates tokens via Cognito authorizer
   - CORS configured for specific origins only

5. **Magic Link Security**:
   - JWT tokens with 1-hour expiration
   - Token validation before use
   - Signed with secret key (in Secrets Manager)

### Production Hardening Recommendations

1. **Environment Variables**:
   - Never commit `.env` file to Git
   - Use AWS Secrets Manager or Parameter Store for production
   - Rotate secrets regularly

2. **HTTPS Only**:
   - Enforce HTTPS in production (Amplify does this automatically)
   - Set secure cookie flags
   - Use HSTS headers

3. **Content Security Policy**:
   - Add CSP headers to prevent XSS
   - Configure in Amplify custom headers or CloudFront

4. **Rate Limiting**:
   - API Gateway has built-in rate limiting (100 req/sec, 200 burst)
   - Consider adding client-side rate limiting for login attempts

5. **Monitoring**:
   - Set up CloudWatch alarms for API errors
   - Monitor authentication failures
   - Track unusual access patterns

## Troubleshooting

### Common Issues

**Issue**: "VITE_USER_POOL_ID is not set"
**Solution**: Make sure `.env` file exists and has all required values. Copy from `.env.example` and fill in values from CDK deployment.

**Issue**: "Network Error" when calling API
**Solution**: Check that `VITE_API_URL` is correct. Verify API Gateway is deployed and accessible. Check CORS configuration.

**Issue**: "Invalid token" errors
**Solution**: Token may have expired. Sign out and sign back in. Check Cognito User Pool is correctly configured.

**Issue**: Calendar not loading
**Solution**: Verify API Gateway endpoints are working. Check that reflections table has data. Ensure user has valid session.

**Issue**: Magic links not working
**Solution**: Verify JWT secret is configured in Secrets Manager. Check token expiration time. Ensure frontend is parsing token correctly.

**Issue**: Styles not loading
**Solution**: Make sure Tailwind is configured correctly. Run `npm run build` to regenerate styles. Check `postcss.config.js` and `tailwind.config.js`.

## Performance Optimization

### Current Optimizations

1. **Code Splitting**: React Router automatically splits routes
2. **Tree Shaking**: Vite removes unused code
3. **Minification**: Production builds are minified
4. **Caching**: Vite generates cache-busted filenames

### Future Optimizations

1. **Lazy Loading**: Implement lazy loading for page components
2. **Service Worker**: Add PWA support with offline capability
3. **Image Optimization**: Optimize any future images
4. **Bundle Analysis**: Run bundle analyzer to identify large dependencies

## Cost Breakdown

**Frontend Hosting (Amplify)**:
- Free tier: 1,000 build minutes/month, 15 GB served/month
- Estimated cost: $0.50-1.00/month for typical usage

**Total Phase 4 Cost**: ~$0.50/month

**Combined Cost (All Phases)**:
- Backend (Phases 1-3): ~$10.50/month
- Frontend (Phase 4): ~$0.50/month
- **Total**: ~$11.00/month (45% under $20 budget!)

## Next Steps

With Phase 4 complete, the application is now fully functional! Next recommended phases:

**Phase 5: Deployment & Monitoring**
- Deploy frontend to Amplify Hosting
- Set up CloudWatch dashboards
- Configure alarms for errors and performance
- Set up logging and metrics

**Phase 6: Testing**
- End-to-end testing (Playwright/Cypress)
- Load testing
- Security audit
- Accessibility testing (WCAG 2.1 AA compliance)

**Phase 7: Beta Launch**
- Invite beta users
- Gather feedback
- Fix bugs and iterate
- Performance tuning

## Support & Documentation

- **Backend API docs**: See `PHASE2_SETUP_GUIDE.md`
- **Migration plan**: See `MIGRATION_PLAN.md`
- **CDK deployment**: See `DEPLOYMENT.md`
- **Security details**: See `SECURITY.md`

---

**Phase 4 Status**: ✅ Complete

**Next Phase**: Phase 5 - Deployment & Monitoring
